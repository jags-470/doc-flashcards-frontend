<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document Flashcards</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <style>
    :root{
      --bg-1: #f6f9ff;
      --bg-2: #eef6ff;
      --accent-1: #3b82f6;
      --accent-2: #60a5fa;
      --muted: #6b7280;
    }

    *{ box-sizing: border-box; }
    html, body{ height: 100%; margin: 0; padding: 0; }
    
    body {
      font-family: 'Poppins', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background: linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 60%);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      color: #0f172a;
      margin: 24px;
      padding: 0;
    }

    /* Two-Column Layout */
    .mainLayout{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      height: calc(100vh - 48px);
    }

    .inputPanel, .cardsPanel{
      display: flex;
      flex-direction: column;
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(248,250,255,0.98));
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,0.03);
      overflow: hidden;
      box-shadow: 0 12px 40px rgba(16,24,40,0.08);
      animation: slideInSmooth 600ms cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .panelContent{
      padding: 28px;
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .mainTitle{
      font-size: 32px;
      font-weight: 700;
      color: #07204a;
      margin: 0 0 28px 0;
      letter-spacing: -0.02em;
    }

    .panelTitle{
      font-size: 20px;
      font-weight: 600;
      color: #0b2545;
      margin: 0 0 20px 0;
      border-bottom: 2px solid rgba(59,130,246,0.1);
      padding-bottom: 12px;
    }

    .inputSection{
      margin-bottom: 28px;
      animation: fadeInUp 500ms ease-out 100ms both;
    }

    .sectionLabel{
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      opacity: 0.8;
    }

    .docTextarea{
      width: 100%;
      min-height: 140px;
      padding: 14px 12px;
      border: 1px solid rgba(15,23,42,0.06);
      border-radius: 10px;
      font-size: 14px;
      color: #0f172a;
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(250,252,255,0.95));
      font-family: inherit;
      resize: vertical;
      transition: box-shadow 180ms ease, border-color 180ms ease, transform 120ms ease;
    }

    .docTextarea:focus{
      outline: none;
      border-color: rgba(59,130,246,0.45);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1), 0 8px 20px rgba(59,130,246,0.08);
      transform: translateY(-2px);
    }

    .helpText{
      font-size: 13px;
      color: var(--muted);
      margin: 8px 0 12px 0;
    }

    .uploadContainer{
      margin-top: 10px;
    }

    .uploadBtn{
      padding: 11px 16px;
      border: 1px solid rgba(15,23,42,0.06);
      background: linear-gradient(90deg, #fff, #f9fbff);
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 200ms cubic-bezier(0.34, 1.56, 0.64, 1);
      color: #0f172a;
    }

    .uploadBtn:hover{
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 20px rgba(59,130,246,0.12);
      border-color: rgba(59,130,246,0.2);
    }

    .uploadBtn:active{
      transform: scale(0.98);
    }

    .settingItem{
      margin-bottom: 16px;
    }

    .settingLabel{
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 6px;
    }

    .numberInput, .textInput{
      width: 100%;
      padding: 10px 12px;
      border: 1px solid rgba(15,23,42,0.06);
      border-radius: 8px;
      font-size: 14px;
      color: #0f172a;
      background: #fff;
      transition: all 180ms ease;
    }

    .numberInput:focus, .textInput:focus{
      outline: none;
      border-color: rgba(59,130,246,0.45);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
      transform: translateY(-1px);
    }

    .settingHint{
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .generateBtn{
      width: 100%;
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      color: #fff;
      border: none;
      padding: 16px 20px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(59,130,246,0.2);
      transition: all 200ms cubic-bezier(0.34, 1.56, 0.64, 1);
      margin-top: auto;
      animation: fadeInUp 500ms ease-out 200ms both;
    }

    .generateBtn:hover:not(:disabled){
      transform: translateY(-4px) scale(1.01);
      box-shadow: 0 16px 32px rgba(59,130,246,0.24);
    }

    .generateBtn:active:not(:disabled){
      transform: scale(0.98);
    }

    .generateBtn:disabled{
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .cardsContainer{
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card{
      border-radius: 12px;
      padding: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(248,250,255,0.98));
      border: 1px solid rgba(15,23,42,0.03);
      transition: transform 200ms ease, box-shadow 200ms ease;
      animation: slideInSmooth 400ms cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .card:hover{
      transform: translateY(-8px);
      /* stronger, subtle grey shadow on hover */
      box-shadow: 0 20px 50px rgba(79,84,92,0.16), 0 6px 18px rgba(79,84,92,0.08);
    }

    .card strong{
      color: #0b3a66;
      font-size: 17px;
    }

    .options{
      margin-top: 12px;
    }

    .options button{
      display: block;
      margin: 8px 0;
      padding: 12px;
      width: 100%;
      border: 1px solid rgba(15,23,42,0.06);
      background: #fff;
      border-radius: 10px;
      text-align: left;
      cursor: pointer;
      font-size: 15px;
      transition: transform 140ms ease, box-shadow 140ms ease, background 140ms ease;
    }

    .options button:hover{
      transform: translateY(-2px);
      box-shadow: 0 8px 18px rgba(2,6,23,0.06);
      background: linear-gradient(90deg, rgba(59,130,246,0.05), rgba(99,102,241,0.03));
    }

    .options button.correct{
      background: linear-gradient(90deg, #d1fae5, #bbf7d0);
      border-color: rgba(34,197,94,0.6);
      font-weight: 600;
    }

    .options button.wrong{
      background: linear-gradient(90deg, #ffeeee, #ffdede);
      border-color: rgba(244,63,94,0.6);
    }

    .answer{
      margin-top: 10px;
      color: var(--muted);
      font-size: 14px;
      font-style: italic;
    }

    .loading{
      text-align: center;
      color: var(--accent-1);
      font-size: 16px;
      margin: 28px 0;
      animation: fadeInUp 400ms ease-out;
    }

    .revealBtn{
      padding: 8px 12px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      color: #fff;
      cursor: pointer;
      transition: transform 140ms ease, box-shadow 140ms ease, opacity 120ms ease;
      margin-top: 10px;
      box-shadow: 0 8px 18px rgba(59,130,246,0.12);
      font-weight: 600;
      font-size: 14px;
    }

    .revealBtn:hover:not(:disabled){
      transform: translateY(-3px);
      box-shadow: 0 14px 32px rgba(59,130,246,0.18);
    }

    .revealBtn:disabled{ opacity: 0.6; cursor: not-allowed; }

    /* Animations */
    @keyframes slideInSmooth{
      from{ opacity: 0; transform: translateY(16px); }
      to{ opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeInUp{
      from{ opacity: 0; transform: translateY(12px); }
      to{ opacity: 1; transform: translateY(0); }
    }

    /* Tablet 1200px and below */
    @media (max-width: 1200px){
      body{ margin: 16px; }
      .mainLayout{ gap: 16px; }
      .panelContent{ padding: 20px; }
      .mainTitle{ font-size: 28px; margin-bottom: 20px; }
    }

    /* Mobile Landscape 900px and below */
    @media (max-width: 900px){
      body{ margin: 12px; }
      .mainLayout{ grid-template-columns: 1fr; gap: 16px; height: auto; }
      .panelContent{ padding: 18px; }
      .mainTitle{ font-size: 26px; }
      .docTextarea{ min-height: 120px; }
    }

    /* Tablet Vertical 768px and below */
    @media (max-width: 768px){
      body{ margin: 10px; }
      .mainLayout{ gap: 14px; }
      .panelContent{ padding: 16px; }
      .mainTitle{ font-size: 24px; margin-bottom: 16px; }
      .panelTitle{ font-size: 18px; margin-bottom: 16px; }
      .inputSection{ margin-bottom: 20px; }
      .generateBtn{ padding: 14px 16px; font-size: 14px; }
      .docTextarea{ min-height: 100px; }
    }

    /* Mobile 480px and below */
    @media (max-width: 480px){
      html, body{ font-size: 14px; }
      body{ margin: 8px; }
      .mainLayout{ gap: 12px; }
      .panelContent{ padding: 12px; }
      .mainTitle{ font-size: 20px; margin-bottom: 12px; }
      .panelTitle{ font-size: 16px; margin-bottom: 12px; }
      .inputSection{ margin-bottom: 16px; }
      .sectionLabel{ font-size: 12px; margin-bottom: 8px; }
      .generateBtn{ padding: 12px 14px; font-size: 13px; margin-top: 12px; }
      .docTextarea{ padding: 10px; min-height: 90px; font-size: 13px; }
      .uploadBtn{ padding: 9px 12px; font-size: 13px; }
      .card{ padding: 14px; margin: 12px 0; }
    }
  </style>
</head>
<body>
  <div class="mainLayout">
    <!-- Left Panel: Input -->
    <div class="inputPanel">
      <div class="panelContent">
        <h1 class="mainTitle">üìö Flashcards</h1>
        
        <div class="inputSection">
          <label class="sectionLabel">Document Input</label>
          <textarea id="docText" class="docTextarea" placeholder="Paste your document text here..."></textarea>
          <p class="helpText">or drag & drop a .txt, .md, or .pdf file</p>
          
          <div class="uploadContainer">
            <input id="fileUpload" type="file" accept=".txt,.md,.pdf" style="display:none" />
            <button id="uploadBtn" class="uploadBtn">üì§ Upload File</button>
          </div>
        </div>

        <div class="inputSection">
          <label class="sectionLabel">Settings</label>
          
          <div class="settingItem">
            <label for="numQuestions" class="settingLabel">Questions to Generate</label>
            <input id="numQuestions" type="number" value="5" min="1" max="25" class="numberInput" />
            <span class="settingHint">(1‚Äì25)</span>
          </div>
          
          <div class="settingItem">
            <label for="backendUrl" class="settingLabel">Backend URL</label>
            <input id="backendUrl" type="text" value="http://localhost:3000" class="textInput" />
            <span class="settingHint">Include protocol and port</span>
          </div>
          <div class="settingItem">
            <label class="settingLabel"><input id="includeTopic" type="checkbox" style="margin-right:8px;vertical-align:middle;" /> Include topic-wide questions</label>
            <input id="topicText" type="text" class="textInput" placeholder="Optional topic (e.g. 'Cloud computing')" disabled />
            <span class="settingHint">When checked, generate questions both from the document and from the broader topic.</span>
          </div>
        </div>

        <button id="generateBtn" class="generateBtn">Generate Flashcards</button>
      </div>
    </div>

    <!-- Right Panel: Cards -->
    <div class="cardsPanel">
      <div class="panelContent">
        <h2 class="panelTitle">Your Flashcards</h2>
        <div id="cardsContainer" class="cardsContainer"></div>
      </div>
    </div>
  </div>

  <script>
    const generateBtn = document.getElementById('generateBtn');
    const docText = document.getElementById('docText');
    const backendUrlInput = document.getElementById('backendUrl');
    const cardsContainer = document.getElementById('cardsContainer');
    const numQuestionsInput = document.getElementById('numQuestions');
    const fileUpload = document.getElementById('fileUpload');
    const uploadBtn = document.getElementById('uploadBtn');
    const includeTopicCheckbox = document.getElementById('includeTopic');
    const topicInput = document.getElementById('topicText');
    const dropZone = document.querySelector('.inputPanel');

    // File upload handler
    if (uploadBtn && fileUpload) {
      uploadBtn.onclick = () => fileUpload.click();
      fileUpload.onchange = async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        try {
          let text = '';
          if (file.name.endsWith('.pdf')) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              text += textContent.items.map(item => item.str).join(' ') + '\n';
            }
          } else {
            text = file.text ? await file.text() : await new Promise((res, rej) => {
              const reader = new FileReader();
              reader.onload = () => res(reader.result);
              reader.onerror = rej;
              reader.readAsText(file);
            });
          }
          docText.value = text;
          docText.focus();
        } catch (err) {
          console.error('File read error', err);
          alert('Failed to read file. Ensure it is a valid .txt, .md, or .pdf file.');
        } finally {
          fileUpload.value = '';
        }
      };
    }

    // toggle topic text input based on checkbox
    if (includeTopicCheckbox && topicInput) {
      includeTopicCheckbox.addEventListener('change', () => {
        topicInput.disabled = !includeTopicCheckbox.checked;
        if (!includeTopicCheckbox.checked) topicInput.value = '';
      });
    }

    generateBtn.onclick = async () => {
      const text = docText.value.trim();
      if (!text) {
        alert('Please paste some document text first.');
        return;
      }
      
      generateBtn.disabled = true;
      generateBtn.textContent = 'Generating...';
      cardsContainer.innerHTML = '<div class="loading">ü§ñ AI is generating your flashcards...</div>';

      try {
        const baseUrl = (backendUrlInput && backendUrlInput.value ? backendUrlInput.value : 'http://localhost:3000').replace(/\/+$/,'');
        const endpoint = `${baseUrl}/api/generate-flashcards`;

        let requested = 5;
        try {
          requested = parseInt(numQuestionsInput && numQuestionsInput.value, 10) || 5;
        } catch (e) { requested = 5; }
        if (requested < 1) requested = 1;
        if (requested > 25) requested = 25;

        const includeTopic = includeTopicCheckbox && includeTopicCheckbox.checked;
        const topic = (topicInput && topicInput.value) ? topicInput.value.trim() : '';

        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ document: text, count: requested, includeTopic, topic })
        });

        if (!res.ok) {
          let bodyText = '';
          try { bodyText = await res.text(); } catch (e) { bodyText = ''; }
          let msg = `Request failed: ${res.status} ${res.statusText}` + (bodyText ? ` ‚Äî ${bodyText}` : '');
          throw new Error(msg);
        }

        const data = await res.json();
        renderCards(data.flashcards || []);
      } catch (e) {
        console.error(e);
        const message = (e && e.message) ? e.message : String(e);
        const safeMsg = escapeHtml(message);
        const hint = message.includes('Failed to execute') || message.includes('Failed to fetch')
          ? 'Browser prevented the request. Check CORS or that the URL/protocol is correct.'
          : 'Ensure backend accepts POST at /api/generate-flashcards and has CORS enabled.';

        cardsContainer.innerHTML = `<div class="card" style="border-color: #f44336;"><strong>‚ùå Error</strong><div style="margin-top:8px;color:#333;">${safeMsg}</div><div style="margin-top:8px;font-size:13px;color:#666;">Hint: ${escapeHtml(hint)}</div></div>`;
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate Flashcards';
      }
    };

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function renderCards(cards) {
      if (!cards.length) {
        cardsContainer.innerHTML = '<div class="card">No flashcards generated. Try with more detailed content.</div>';
        return;
      }
      cardsContainer.innerHTML = '';
      cards.forEach((card, idx) => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div><strong>Q${idx+1}:</strong> ${card.question}</div>
          <div class="options"></div>
          <div class="answer" style="display:none;">Correct answer: ${card.correct}</div>
          <button class="revealBtn">Reveal Answer</button>
        `;
        const optionsDiv = div.querySelector('.options');
        card.options.forEach(opt => {
          const btn = document.createElement('button');
          btn.textContent = opt;
          btn.onclick = () => {
            const allBtns = Array.from(optionsDiv.querySelectorAll('button'));
            allBtns.forEach(b => {
              b.disabled = true;
              b.classList.remove('correct', 'wrong');
            });

            const normalize = s => String(s || '').trim().toLowerCase();
            const chosen = normalize(opt);
            const correct = normalize(card.correct);

            if (chosen === correct) {
              btn.classList.add('correct');
            } else {
              btn.classList.add('wrong');
              allBtns.forEach(b => {
                if (normalize(b.textContent) === correct) {
                  b.classList.add('correct');
                }
              });
            }
          };
          optionsDiv.appendChild(btn);
        });
        const revealBtn = div.querySelector('.revealBtn');
        const answerDiv = div.querySelector('.answer');
        if (revealBtn && answerDiv) {
          revealBtn.onclick = () => {
            answerDiv.style.display = 'block';
            revealBtn.disabled = true;
            revealBtn.style.opacity = '0.6';
            revealBtn.style.cursor = 'not-allowed';
          };
        }

        cardsContainer.appendChild(div);
      });
    }

    // Drag & drop support
    (function() {
      if (!dropZone) return;
      const onDragOver = (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drop-target'); };
      const onDragLeave = (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drop-target'); };
      const onDrop = async (e) => {
        e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drop-target');
        const dt = e.dataTransfer;
        if (!dt) return;

        try {
          if (dt.files && dt.files.length > 0) {
            fileUpload.files = dt.files;
            const evt = new Event('change', { bubbles: true });
            fileUpload.dispatchEvent(evt);
            return;
          }

          const plain = dt.getData && dt.getData('text/plain');
          if (plain) {
            docText.value = plain;
            docText.focus();
          }
        } catch (err) {
          console.error('Drop read error', err);
        }
      };

      ['dragenter','dragover'].forEach(n => dropZone.addEventListener(n, onDragOver));
      ['dragleave','dragexit','drop'].forEach(n => dropZone.addEventListener(n, n === 'drop' ? onDrop : onDragLeave));
    })();
  </script>
</body>
</html>
